---
title: "Individual assignment"
author: "Bernardo"
date: "`r Sys.Date()`"
output: html_document
---

# Individual assignment

## LCS - Lettuce forecasting

## Live session notes

-   There are three months of data

-   Data from 4 different stores

Our data consists of three parts:

1.  Transaction data
2.  List of ingredients --\> quality and quantity
3.  Metadata on restaurants

Forecast the daily demand for the next two weeks (from 16/06/2015 to 29/06/2015) for lettuce for store 46673. We also need to fill in the CSV file. All we have to do there is to substitute the numbers.

So the two steps of the project are:

-   Generate a time series of daily demand of lettuce --\> Most of the time

-   apply ARIMA and Holt-winters to predict the demand

-   Compare the results

### Importing the datasets

First, we import the relevant libraries to the project

```{r}
library(readr)
library(tidyr)
library(dplyr)
library(ggplot2)
```

We start by recognizing the schema of the assignment's dataset:

```{r message=FALSE, warning=FALSE}

# Import the main transactional table, which is "menu_items_all"

main <- read_csv('data/menuitem.csv')

# Columns that are necessary
columns <- c("MD5KEY_ORDERSALE", "StoreNumber", "PLU", "Id", "Quantity")

# Keep only necessary columns
main <- main[,columns]

# Filter for store of interest
main <- filter(main, StoreNumber == 46673)
```

Now we will join that table with the pos_ordersale table to get the date using the "MD5KEY_ORDERSALE" primary key

```{r message=FALSE, warning=FALSE}
# Import pos_ordersale table
pos_ordersale <- read_csv("data/pos_ordersale.csv")

main <- left_join(main, select(pos_ordersale, c("date", "MD5KEY_ORDERSALE")), by="MD5KEY_ORDERSALE")
```

Next, we want to bring in the recipe id. To do that, we will need to join the "menu_items" table on "PLU" and "Id" (left) and "RecipeId" (right)

```{r message=FALSE, warning=FALSE}
# Import pos_ordersale table
menu_items <- read_csv("data/menu_items.csv")

main <- left_join(main, select(menu_items, c("PLU", "MenuItemId", "RecipeId")), by = c("PLU" = "PLU", "Id" = "MenuItemId"))
```

```{r}
main
```

Our main transaction table is ready. Now, we need to figure out the quantity of lettuce per recipe. Then, we will be able to group the main table by date and have a total of lettuce demand for each day. Let's start by identifying the id of lettuce in the dataset

```{r}
# Grab lettuce's id
filter(ingredients, grepl("Lettuce", IngredientName, ignore.case = TRUE))
```

We see that there are two lettuces in the dataset. We know from the live session that the metric lettuce is not used in any of the transactions. Therefore, we will take 27 as the only id for lettuce.

Next, we import the recipes dataset

```{r message=FALSE, warning=FALSE}

# Importing recipes dataset

recipes <- read_csv("data/recipes.csv")
```

Then, we know that the ingredients can be used in an item in two ways: Via the ingredients directly or the sub-recipe. We will start by adding the lettuce quantities that come directly from the ingredients table.

```{r message=FALSE, warning=FALSE}

# Importing recipe_ingredients

recipe_ingredient_assignments <- read_csv("data/recipe_ingredient_assignments.csv")
# Filter only for lettuce

recipe_ingredient_assignments <- filter(recipe_ingredient_assignments, 
                                        IngredientId == 27)

# Join in the recipe table
recipes <- left_join(recipes, select(recipe_ingredient_assignments,
                                   c("RecipeId", "Quantity")), 
                    by="RecipeId") %>%
# Mutate to change the NA's to 0
           mutate(Quantity = ifelse(is.na(Quantity), 0, Quantity)) %>%
#Change the name of the column to specify it comes from direct  
           rename(quantity_from_direct = Quantity)
```

Now, we need to get the quantity of lettuce from the sub-recipes

```{r message=FALSE, warning=FALSE}

# Import sub recipe assignment dataset
recipe_sub_recipe_assignments <- read_csv("data/recipe_sub_recipe_assignments.csv")

# Import the sub_recipes ingredients assignment
sub_recipe_ingr_assignments <- read_csv("data/sub_recipe_ingr_assignments.csv")

# Join the sub_recipes with ingredients to get the recipe id
recipe_sub_recipe_joint <- left_join(sub_recipe_ingr_assignments,
                                     recipe_sub_recipe_assignments, 
                                     by='SubRecipeId')

# Filter for lettuce
recipe_sub_recipe_joint <- filter(recipe_sub_recipe_joint,
                                  IngredientId == 27) %>%
                           mutate(total_quantity = Factor*Quantity)

# Group by recipe
recipe_sub_recipe_joint <- recipe_sub_recipe_joint %>%
  group_by(RecipeId) %>%
  summarise(total_quantity = sum(total_quantity, na.rm = TRUE))

# Join with the recipes table
recipes_final <- left_join(recipes, recipe_sub_recipe_joint, by="RecipeId") %>%
# Mutate to change the NA's to 0
           mutate(total_quantity = ifelse(is.na(total_quantity), 
                                          0, total_quantity)) %>%
#Change the name of the column to specify it comes from direct  
           rename(quantity_from_sub = total_quantity) %>%
#Sum the two columns to get the total of lettuce
           mutate(total_lettuce = quantity_from_direct + quantity_from_sub) %>%
#Filter out recipes that do not have lettuce
           filter(total_lettuce > 0)
```

Then, we join our main transactional table again with this ingredietns adjusted table:

```{r message=FALSE, warning=FALSE}

# Join the main transactional table with recipes to get the final table
final <- left_join(main, select(recipes_final,
                                     c("RecipeId", "total_lettuce")), 
                        by="RecipeId") %>%
# Filter out NA's
              filter(!is.na(total_lettuce)) %>%
# Multiply by total quantity
              mutate(total_lettuce = Quantity*total_lettuce) %>%
# Group by date
              group_by(date) %>%
              summarise(total_lettuce = sum(total_lettuce))
final
```

The final step is to create a time-series out of it:

```{r}
# Transforming date field from the final table
final$date<- as.Date(paste0("20", substr(final$date, 1, 2), "-", substr(final$date, 4, 5), "-", substr(final$date, 7, 8)))

# Build time series
ts <- ts(final, start = min(final$date), frequency = 7)

# Plot the time series directly using ggplot2
ggplot(final, aes(date, total_lettuce)) + 
  geom_line() + 
  labs(title = "Time Series Plot of Lettuce Sales",
       x = "Date",
       y = "Total Lettuce Sales")

```

# Arima application

# Winter-holz
